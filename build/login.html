<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>APIå¯†é’¥è®¾ç½® - MTG AI æœç´¢å·¥å…·</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: #0a0a0a;
        min-height: 100vh;
        padding: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #ffffff;
      }

      .login-container {
        max-width: 500px;
        width: 100%;
        background: #1a1a1a;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        overflow: hidden;
        border: 1px solid #333333;
      }

      .header {
        background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 100%);
        color: white;
        padding: 30px;
        text-align: center;
        border-bottom: 1px solid #333333;
      }

      .header h1 {
        font-size: 2rem;
        margin-bottom: 10px;
      }

      .header p {
        font-size: 1rem;
        opacity: 0.9;
      }

      .form-section {
        padding: 40px;
        background: #1a1a1a;
      }

      .form-group {
        margin-bottom: 25px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #e5e7eb;
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: 15px;
        border: 2px solid #374151;
        border-radius: 10px;
        font-size: 16px;
        transition: border-color 0.3s;
        background: #2d2d2d;
        color: #ffffff;
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: #3b82f6;
        background: #374151;
      }

      .form-group input::placeholder {
        color: #9ca3af;
      }

      .api-key-input {
        font-family: monospace;
        letter-spacing: 1px;
      }

      .btn {
        width: 100%;
        padding: 15px;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s;
        margin-bottom: 15px;
      }

      .btn-primary {
        background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
      }

      .btn-secondary {
        background: #374151;
        color: #e5e7eb;
        border: 2px solid #4b5563;
      }

      .btn-secondary:hover {
        background: #4b5563;
        border-color: #6b7280;
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .info-box {
        background: #2d2d2d;
        border: 1px solid #374151;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 25px;
      }

      .info-box h3 {
        color: #e5e7eb;
        margin-bottom: 10px;
        font-size: 1.1rem;
      }

      .info-box p {
        color: #d1d5db;
        line-height: 1.6;
        margin-bottom: 10px;
      }

      .info-box ul {
        margin-left: 20px;
        color: #d1d5db;
      }

      .info-box li {
        margin-bottom: 5px;
      }

      .status-message {
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        display: none;
      }

      .status-success {
        background: #065f46;
        color: #d1fae5;
        border: 1px solid #047857;
      }

      .status-error {
        background: #7f1d1d;
        color: #fecaca;
        border: 1px solid #dc2626;
      }

      .demo-mode {
        background: #451a03;
        color: #fed7aa;
        border: 1px solid #ea580c;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        text-align: center;
      }

      .link {
        color: #3b82f6;
        text-decoration: none;
      }

      .link:hover {
        text-decoration: underline;
        color: #60a5fa;
      }

      .btn-refresh {
        margin-top: 10px;
        padding: 8px 16px;
        background: #374151;
        border: 1px solid #4b5563;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s;
        color: #e5e7eb;
      }

      .btn-refresh:hover {
        background: #4b5563;
        border-color: #6b7280;
      }

      @media (max-width: 768px) {
        .login-container {
          margin: 10px;
        }

        .header {
          padding: 20px;
        }

        .form-section {
          padding: 20px;
        }

        .header h1 {
          font-size: 1.5rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="login-container">
      <div class="header">
        <div class="language-toggle" style="text-align: right; margin-bottom: 15px;">
          <button class="lang-btn active" data-lang="zh" style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 6px; margin-left: 10px; cursor: pointer;">ä¸­æ–‡</button>
          <button class="lang-btn" data-lang="en" style="background: #2d2d2d; color: #e5e7eb; border: 1px solid #374151; padding: 8px 16px; border-radius: 6px; margin-left: 10px; cursor: pointer;">English</button>
        </div>
        <h1 id="pageTitle">ğŸ”‘ APIå¯†é’¥è®¾ç½®</h1>
        <p id="pageSubtitle">é…ç½®æ‚¨çš„AIæœåŠ¡å¯†é’¥ä»¥è·å¾—æ›´å¥½çš„æœç´¢ä½“éªŒ</p>
      </div>

      <div class="form-section">
        <div class="demo-mode" id="demoMode">
          <strong>ğŸ’¡ æç¤ºï¼š</strong> æ‚¨ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨æ¼”ç¤ºæ¨¡å¼ï¼Œæ— éœ€APIå¯†é’¥
        </div>

        <div class="info-box">
          <h3 id="supportedServicesTitle">ğŸ¤– æ”¯æŒçš„AIæœåŠ¡</h3>
          <p id="supportedServicesDesc">æˆ‘ä»¬æ”¯æŒä»¥ä¸‹AIæœåŠ¡æä¾›å•†ï¼š</p>
          <ul>
            <li><strong>Aihubmix</strong> - <span id="aihubmixDesc">æ¨èï¼Œå¤§é™†ç”¨æˆ·ç›´è¿ä½¿ç”¨</span></li>
            <li><strong>OpenAI</strong> - <span id="openaiDesc">éœ€è¦ç½‘ç»œä»£ç†</span></li>
          </ul>
          <p>
            <a
              href="https://docs.aihubmix.com/cn/api/Aihubmix-Integration"
              target="_blank"
              class="link"
              id="apiDocLink"
              >ğŸ“– æŸ¥çœ‹Aihubmix APIæ–‡æ¡£</a
            >
          </p>
        </div>

        <div id="statusMessage" class="status-message"></div>

        <form id="apiKeyForm">
          <div class="form-group">
            <label for="provider" id="providerLabel">AIæœåŠ¡æä¾›å•†</label>
            <select id="provider" name="provider">
              <option value="aihubmix">Aihubmix (æ¨è)</option>
              <option value="openai">OpenAI</option>
            </select>
          </div>

          <div class="form-group">
            <label for="model" id="modelLabel">AIæ¨¡å‹</label>
            <select id="model" name="model">
              <option value="" id="modelPlaceholder">è¯·å…ˆé€‰æ‹©æä¾›å•†å¹¶è¾“å…¥APIå¯†é’¥</option>
            </select>
            <button
              type="button"
              id="refreshModelsBtn"
              class="btn-refresh"
              style="display: none"
            >
              ğŸ”„ <span id="refreshText">åˆ·æ–°æ¨¡å‹åˆ—è¡¨</span>
            </button>
          </div>

          <div class="form-group">
            <label for="apiKey" id="apiKeyLabel">APIå¯†é’¥</label>
            <input
              type="password"
              id="apiKey"
              name="apiKey"
              class="api-key-input"
              placeholder="è¯·è¾“å…¥æ‚¨çš„APIå¯†é’¥"
              required
            />
          </div>

          <button type="submit" class="btn btn-primary" id="validateBtn">
            <span id="validateText">éªŒè¯å¹¶ä¿å­˜</span>
          </button>
        </form>

        <button class="btn btn-secondary" id="demoBtn">
          <span id="demoText">ä½¿ç”¨æ¼”ç¤ºæ¨¡å¼</span>
        </button>
      </div>
    </div>

    <script>
      // è¿æ¥åˆ°äº‘ç«¯åç«¯API
      const API_BASE_URL = "https://mtg-ai-backend.onrender.com";

      // è¯­è¨€é…ç½®
      const translations = {
        zh: {
          pageTitle: "ğŸ”‘ APIå¯†é’¥è®¾ç½®",
          pageSubtitle: "é…ç½®æ‚¨çš„AIæœåŠ¡å¯†é’¥ä»¥è·å¾—æ›´å¥½çš„æœç´¢ä½“éªŒ",
          demoMode: "ğŸ’¡ æç¤ºï¼š æ‚¨ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨æ¼”ç¤ºæ¨¡å¼ï¼Œæ— éœ€APIå¯†é’¥",
          supportedServicesTitle: "ğŸ¤– æ”¯æŒçš„AIæœåŠ¡",
          supportedServicesDesc: "æˆ‘ä»¬æ”¯æŒä»¥ä¸‹AIæœåŠ¡æä¾›å•†ï¼š",
          aihubmixDesc: "æ¨èï¼Œå¤§é™†ç”¨æˆ·ç›´è¿ä½¿ç”¨",
          openaiDesc: "éœ€è¦ç½‘ç»œä»£ç†",
          apiDocLink: "ğŸ“– æŸ¥çœ‹Aihubmix APIæ–‡æ¡£",
          providerLabel: "AIæœåŠ¡æä¾›å•†",
          modelLabel: "AIæ¨¡å‹",
          modelPlaceholder: "è¯·å…ˆé€‰æ‹©æä¾›å•†å¹¶è¾“å…¥APIå¯†é’¥",
          refreshText: "åˆ·æ–°æ¨¡å‹åˆ—è¡¨",
          apiKeyLabel: "APIå¯†é’¥",
          apiKeyPlaceholder: "è¯·è¾“å…¥æ‚¨çš„APIå¯†é’¥",
          validateText: "éªŒè¯å¹¶ä¿å­˜",
          demoText: "ä½¿ç”¨æ¼”ç¤ºæ¨¡å¼",
          validatingText: "éªŒè¯ä¸­...",
          modelsLoadingText: "æ­£åœ¨è·å–æ¨¡å‹åˆ—è¡¨...",
          modelsFailedText: "è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥",
          modelsRefreshedText: "æ¨¡å‹åˆ—è¡¨å·²åˆ·æ–°"
        },
        en: {
          pageTitle: "ğŸ”‘ API Key Settings",
          pageSubtitle: "Configure your AI service keys for better search experience",
          demoMode: "ğŸ’¡ Tip: You can also use demo mode directly without API keys",
          supportedServicesTitle: "ğŸ¤– Supported AI Services",
          supportedServicesDesc: "We support the following AI service providers:",
          aihubmixDesc: "Recommended, direct connection for mainland users",
          openaiDesc: "Requires network proxy",
          apiDocLink: "ğŸ“– View Aihubmix API Documentation",
          providerLabel: "AI Service Provider",
          modelLabel: "AI Model",
          modelPlaceholder: "Please select provider and enter API key first",
          refreshText: "Refresh Model List",
          apiKeyLabel: "API Key",
          apiKeyPlaceholder: "Please enter your API key",
          validateText: "Validate & Save",
          demoText: "Use Demo Mode",
          validatingText: "Validating...",
          modelsLoadingText: "Loading model list...",
          modelsFailedText: "Failed to load model list",
          modelsRefreshedText: "Model list refreshed"
        }
      };

      let currentLanguage = "zh";

      // è¯­è¨€åˆ‡æ¢åŠŸèƒ½
      function switchLanguage(lang) {
        currentLanguage = lang;
        
        // æ›´æ–°æŒ‰é’®æ ·å¼
        document.querySelectorAll('.lang-btn').forEach(btn => {
          btn.classList.remove('active');
          if (btn.dataset.lang === lang) {
            btn.classList.add('active');
            btn.style.background = '#3b82f6';
            btn.style.color = 'white';
            btn.style.border = 'none';
          } else {
            btn.style.background = '#2d2d2d';
            btn.style.color = '#e5e7eb';
            btn.style.border = '1px solid #374151';
          }
        });

        // æ›´æ–°é¡µé¢æ–‡æœ¬
        const t = translations[lang];
        document.getElementById('pageTitle').textContent = t.pageTitle;
        document.getElementById('pageSubtitle').textContent = t.pageSubtitle;
        document.getElementById('demoMode').innerHTML = `<strong>${t.demoMode}</strong>`;
        document.getElementById('supportedServicesTitle').textContent = t.supportedServicesTitle;
        document.getElementById('supportedServicesDesc').textContent = t.supportedServicesDesc;
        document.getElementById('aihubmixDesc').textContent = t.aihubmixDesc;
        document.getElementById('openaiDesc').textContent = t.openaiDesc;
        document.getElementById('apiDocLink').textContent = t.apiDocLink;
        document.getElementById('providerLabel').textContent = t.providerLabel;
        document.getElementById('modelLabel').textContent = t.modelLabel;
        document.getElementById('modelPlaceholder').textContent = t.modelPlaceholder;
        document.getElementById('refreshText').textContent = t.refreshText;
        document.getElementById('apiKeyLabel').textContent = t.apiKeyLabel;
        document.getElementById('apiKey').placeholder = t.apiKeyPlaceholder;
        document.getElementById('validateText').textContent = t.validateText;
        document.getElementById('demoText').textContent = t.demoText;
      }

      // è¯­è¨€åˆ‡æ¢æŒ‰é’®äº‹ä»¶
      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          switchLanguage(btn.dataset.lang);
        });
      });

      // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
      function showStatus(message, type = "success") {
        const statusDiv = document.getElementById("statusMessage");
        statusDiv.textContent = message;
        statusDiv.className = `status-message status-${type}`;
        statusDiv.style.display = "block";

        // 3ç§’åè‡ªåŠ¨éšè—
        setTimeout(() => {
          statusDiv.style.display = "none";
        }, 3000);
      }

      // è·å–æ¨¡å‹åˆ—è¡¨
      async function getModels(apiKey, provider) {
        try {
          const response = await fetch(`${API_BASE_URL}/api/models`, {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
            },
          });

          const result = await response.json();
          return result;
        } catch (error) {
          console.error("è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥:", error);
          return {
            success: false,
            models: [],
            message: "ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œ",
          };
        }
      }

      // éªŒè¯APIå¯†é’¥
      async function validateApiKey(apiKey, provider, model) {
        try {
          const response = await fetch(`${API_BASE_URL}/api/validate-key`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              api_key: apiKey,
              provider: provider,
              model: model,
            }),
          });

          const result = await response.json();
          return result;
        } catch (error) {
          console.error("éªŒè¯å¤±è´¥:", error);
          return {
            valid: false,
            message: "ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œ",
          };
        }
      }

      // ä¿å­˜APIå¯†é’¥åˆ°æœ¬åœ°å­˜å‚¨
      function saveApiKey(apiKey, provider, model) {
        localStorage.setItem("mtg_ai_api_key", apiKey);
        localStorage.setItem("mtg_ai_provider", provider);
        localStorage.setItem("mtg_ai_model", model);
        localStorage.setItem("mtg_ai_configured", "true");
      }

      // è¡¨å•æäº¤å¤„ç†
      document
        .getElementById("apiKeyForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const apiKey = document.getElementById("apiKey").value.trim();
          const provider = document.getElementById("provider").value;
          const model = document.getElementById("model").value;
          const validateBtn = document.getElementById("validateBtn");

          if (!apiKey) {
            const t = translations[currentLanguage];
            showStatus(t.apiKeyPlaceholder, "error");
            return;
          }

          // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
          validateBtn.disabled = true;
          const t = translations[currentLanguage];
          validateBtn.textContent = t.validatingText;

          try {
            const result = await validateApiKey(apiKey, provider, model);

            if (result.valid) {
              showStatus("âœ… APIå¯†é’¥éªŒè¯æˆåŠŸï¼", "success");
              saveApiKey(apiKey, provider, model);

              // å»¶è¿Ÿè·³è½¬åˆ°ä¸»é¡µé¢
              setTimeout(() => {
                window.location.href = "index.html";
              }, 1500);
            } else {
              showStatus(`âŒ ${result.message}`, "error");
            }
          } catch (error) {
            showStatus("éªŒè¯è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯", "error");
          } finally {
            validateBtn.disabled = false;
            const t = translations[currentLanguage];
            validateBtn.textContent = t.validateText;
          }
        });

      // åŠ¨æ€è·å–æ¨¡å‹åˆ—è¡¨
      async function loadModels(apiKey, provider) {
        const modelSelect = document.getElementById("model");
        const refreshBtn = document.getElementById("refreshModelsBtn");
        const t = translations[currentLanguage];

        if (!apiKey || !provider) {
          modelSelect.innerHTML = `<option value="">${t.modelPlaceholder}</option>`;
          refreshBtn.style.display = "none";
          return;
        }

        modelSelect.innerHTML = `<option value="">${t.modelsLoadingText}</option>`;
        refreshBtn.style.display = "none";

        const result = await getModels(apiKey, provider);

        if (result.success || result.models.length > 0) {
          modelSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æ¨¡å‹</option>';
          result.models.forEach((model) => {
            const option = document.createElement("option");
            option.value = model.id;
            option.textContent = model.name;
            modelSelect.appendChild(option);
          });
          refreshBtn.style.display = "inline-block";
        } else {
          modelSelect.innerHTML = `<option value="">${t.modelsFailedText}</option>`;
        }
      }

      // æä¾›å•†æˆ–APIå¯†é’¥å˜åŒ–æ—¶è·å–æ¨¡å‹åˆ—è¡¨
      document.getElementById("provider").addEventListener("change", () => {
        const apiKey = document.getElementById("apiKey").value.trim();
        const provider = document.getElementById("provider").value;
        if (apiKey) {
          loadModels(apiKey, provider);
        }
      });

      document.getElementById("apiKey").addEventListener("input", () => {
        const apiKey = document.getElementById("apiKey").value.trim();
        const provider = document.getElementById("provider").value;
        if (apiKey && provider) {
          loadModels(apiKey, provider);
        }
      });

      // åˆ·æ–°æ¨¡å‹åˆ—è¡¨æŒ‰é’®
              document
          .getElementById("refreshModelsBtn")
          .addEventListener("click", async () => {
            const apiKey = document.getElementById("apiKey").value.trim();
            const provider = document.getElementById("provider").value;
            if (apiKey && provider) {
              await loadModels(apiKey, provider);
              const t = translations[currentLanguage];
              showStatus(t.modelsRefreshedText, "success");
            }
          });

      // æ¼”ç¤ºæ¨¡å¼æŒ‰é’®
      document.getElementById("demoBtn").addEventListener("click", () => {
        localStorage.setItem("mtg_ai_configured", "true");
        localStorage.removeItem("mtg_ai_api_key");
        localStorage.removeItem("mtg_ai_provider");
        localStorage.removeItem("mtg_ai_model");
        window.location.href = "index.html";
      });

      // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦å·²ç»é…ç½®
      document.addEventListener("DOMContentLoaded", () => {
        const isConfigured = localStorage.getItem("mtg_ai_configured");
        if (isConfigured === "true") {
          // å¦‚æœå·²ç»é…ç½®è¿‡ï¼Œç›´æ¥è·³è½¬åˆ°ä¸»é¡µé¢
          window.location.href = "index.html";
        }
      });
    </script>
  </body>
</html>
