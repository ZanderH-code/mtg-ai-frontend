<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>API密钥设置 - MTG AI 搜索工具</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .login-container {
        max-width: 500px;
        width: 100%;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2rem;
        margin-bottom: 10px;
      }

      .header p {
        font-size: 1rem;
        opacity: 0.9;
      }

      .form-section {
        padding: 40px;
      }

      .form-group {
        margin-bottom: 25px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #2c3e50;
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: 15px;
        border: 2px solid #e1e8ed;
        border-radius: 10px;
        font-size: 16px;
        transition: border-color 0.3s;
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: #667eea;
      }

      .api-key-input {
        font-family: monospace;
        letter-spacing: 1px;
      }

      .btn {
        width: 100%;
        padding: 15px;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s;
        margin-bottom: 15px;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .btn-secondary {
        background: #f8f9fa;
        color: #6c757d;
        border: 2px solid #e1e8ed;
      }

      .btn-secondary:hover {
        background: #e9ecef;
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .info-box {
        background: #f8f9fa;
        border: 1px solid #e1e8ed;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 25px;
      }

      .info-box h3 {
        color: #2c3e50;
        margin-bottom: 10px;
        font-size: 1.1rem;
      }

      .info-box p {
        color: #6c757d;
        line-height: 1.6;
        margin-bottom: 10px;
      }

      .info-box ul {
        margin-left: 20px;
        color: #6c757d;
      }

      .info-box li {
        margin-bottom: 5px;
      }

      .status-message {
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        display: none;
      }

      .status-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .demo-mode {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        text-align: center;
      }

      .link {
        color: #667eea;
        text-decoration: none;
      }

      .link:hover {
        text-decoration: underline;
      }

      .btn-refresh {
        margin-top: 10px;
        padding: 8px 16px;
        background: #f8f9fa;
        border: 1px solid #e1e8ed;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s;
      }

      .btn-refresh:hover {
        background: #e9ecef;
      }

      @media (max-width: 768px) {
        .login-container {
          margin: 10px;
        }

        .header {
          padding: 20px;
        }

        .form-section {
          padding: 20px;
        }

        .header h1 {
          font-size: 1.5rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="login-container">
      <div class="header">
        <h1>🔑 API密钥设置</h1>
        <p>配置您的AI服务密钥以获得更好的搜索体验</p>
      </div>

      <div class="form-section">
        <div class="demo-mode">
          <strong>💡 提示：</strong> 您也可以直接使用演示模式，无需API密钥
        </div>

        <div class="info-box">
          <h3>🤖 支持的AI服务</h3>
          <p>我们支持以下AI服务提供商：</p>
          <ul>
            <li><strong>Aihubmix</strong> - 推荐，大陆用户直连使用</li>
            <li><strong>OpenAI</strong> - 需要网络代理</li>
          </ul>
          <p>
            <a
              href="https://docs.aihubmix.com/cn/api/Aihubmix-Integration"
              target="_blank"
              class="link"
              >📖 查看Aihubmix API文档</a
            >
          </p>
        </div>

        <div id="statusMessage" class="status-message"></div>

        <form id="apiKeyForm">
          <div class="form-group">
            <label for="provider">AI服务提供商</label>
            <select id="provider" name="provider">
              <option value="aihubmix">Aihubmix (推荐)</option>
              <option value="openai">OpenAI</option>
            </select>
          </div>

          <div class="form-group">
            <label for="model">AI模型</label>
            <select id="model" name="model">
              <option value="">请先选择提供商并输入API密钥</option>
            </select>
            <button
              type="button"
              id="refreshModelsBtn"
              class="btn-refresh"
              style="display: none"
            >
              🔄 刷新模型列表
            </button>
          </div>

          <div class="form-group">
            <label for="apiKey">API密钥</label>
            <input
              type="password"
              id="apiKey"
              name="apiKey"
              class="api-key-input"
              placeholder="请输入您的API密钥"
              required
            />
          </div>

          <button type="submit" class="btn btn-primary" id="validateBtn">
            验证并保存
          </button>
        </form>

        <button class="btn btn-secondary" id="demoBtn">使用演示模式</button>
      </div>
    </div>

    <script>
             // 根据环境自动选择API地址
       const API_BASE_URL = window.location.hostname === 'localhost' 
         ? "http://localhost:8000" 
         : "https://mtg-ai-backend.onrender.com";

      // 显示状态消息
      function showStatus(message, type = "success") {
        const statusDiv = document.getElementById("statusMessage");
        statusDiv.textContent = message;
        statusDiv.className = `status-message status-${type}`;
        statusDiv.style.display = "block";

        // 3秒后自动隐藏
        setTimeout(() => {
          statusDiv.style.display = "none";
        }, 3000);
      }

      // 获取模型列表
      async function getModels(apiKey, provider) {
        try {
          const response = await fetch(`${API_BASE_URL}/api/models`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              api_key: apiKey,
              provider: provider,
            }),
          });

          const result = await response.json();
          return result;
        } catch (error) {
          console.error("获取模型列表失败:", error);
          return {
            success: false,
            models: [],
            message: "网络连接失败，请检查后端服务是否运行",
          };
        }
      }

      // 验证API密钥
      async function validateApiKey(apiKey, provider, model) {
        try {
          const response = await fetch(`${API_BASE_URL}/api/validate-key`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              api_key: apiKey,
              provider: provider,
              model: model,
            }),
          });

          const result = await response.json();
          return result;
        } catch (error) {
          console.error("验证失败:", error);
          return {
            valid: false,
            message: "网络连接失败，请检查后端服务是否运行",
          };
        }
      }

      // 保存API密钥到本地存储
      function saveApiKey(apiKey, provider, model) {
        localStorage.setItem("mtg_ai_api_key", apiKey);
        localStorage.setItem("mtg_ai_provider", provider);
        localStorage.setItem("mtg_ai_model", model);
        localStorage.setItem("mtg_ai_configured", "true");
      }

      // 表单提交处理
      document
        .getElementById("apiKeyForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const apiKey = document.getElementById("apiKey").value.trim();
          const provider = document.getElementById("provider").value;
          const model = document.getElementById("model").value;
          const validateBtn = document.getElementById("validateBtn");

          if (!apiKey) {
            showStatus("请输入API密钥", "error");
            return;
          }

          // 显示加载状态
          validateBtn.disabled = true;
          validateBtn.textContent = "验证中...";

          try {
            const result = await validateApiKey(apiKey, provider, model);

            if (result.valid) {
              showStatus("✅ API密钥验证成功！", "success");
              saveApiKey(apiKey, provider, model);

              // 延迟跳转到主页面
              setTimeout(() => {
                window.location.href = "index.html";
              }, 1500);
            } else {
              showStatus(`❌ ${result.message}`, "error");
            }
          } catch (error) {
            showStatus("验证过程中发生错误", "error");
          } finally {
            validateBtn.disabled = false;
            validateBtn.textContent = "验证并保存";
          }
        });

      // 动态获取模型列表
      async function loadModels(apiKey, provider) {
        const modelSelect = document.getElementById("model");
        const refreshBtn = document.getElementById("refreshModelsBtn");

        if (!apiKey || !provider) {
          modelSelect.innerHTML =
            '<option value="">请先选择提供商并输入API密钥</option>';
          refreshBtn.style.display = "none";
          return;
        }

        modelSelect.innerHTML = '<option value="">正在获取模型列表...</option>';
        refreshBtn.style.display = "none";

        const result = await getModels(apiKey, provider);

        if (result.success || result.models.length > 0) {
          modelSelect.innerHTML = '<option value="">请选择模型</option>';
          result.models.forEach((model) => {
            const option = document.createElement("option");
            option.value = model.id;
            option.textContent = model.name;
            modelSelect.appendChild(option);
          });
          refreshBtn.style.display = "inline-block";
        } else {
          modelSelect.innerHTML = '<option value="">获取模型列表失败</option>';
        }
      }

      // 提供商或API密钥变化时获取模型列表
      document.getElementById("provider").addEventListener("change", () => {
        const apiKey = document.getElementById("apiKey").value.trim();
        const provider = document.getElementById("provider").value;
        if (apiKey) {
          loadModels(apiKey, provider);
        }
      });

      document.getElementById("apiKey").addEventListener("input", () => {
        const apiKey = document.getElementById("apiKey").value.trim();
        const provider = document.getElementById("provider").value;
        if (apiKey && provider) {
          loadModels(apiKey, provider);
        }
      });

      // 刷新模型列表按钮
      document
        .getElementById("refreshModelsBtn")
        .addEventListener("click", async () => {
          const apiKey = document.getElementById("apiKey").value.trim();
          const provider = document.getElementById("provider").value;
          if (apiKey && provider) {
            await loadModels(apiKey, provider);
            showStatus("模型列表已刷新", "success");
          }
        });

      // 演示模式按钮
      document.getElementById("demoBtn").addEventListener("click", () => {
        localStorage.setItem("mtg_ai_configured", "true");
        localStorage.removeItem("mtg_ai_api_key");
        localStorage.removeItem("mtg_ai_provider");
        localStorage.removeItem("mtg_ai_model");
        window.location.href = "index.html";
      });

      // 页面加载时检查是否已经配置
      document.addEventListener("DOMContentLoaded", () => {
        const isConfigured = localStorage.getItem("mtg_ai_configured");
        if (isConfigured === "true") {
          // 如果已经配置过，直接跳转到主页面
          window.location.href = "index.html";
        }
      });
    </script>
  </body>
</html>
