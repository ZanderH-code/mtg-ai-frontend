<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>APIå¯†é’¥è®¾ç½® - MTG AI æœç´¢å·¥å…·</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .login-container {
        max-width: 500px;
        width: 100%;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2rem;
        margin-bottom: 10px;
      }

      .header p {
        font-size: 1rem;
        opacity: 0.9;
      }

      .form-section {
        padding: 40px;
      }

      .form-group {
        margin-bottom: 25px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #2c3e50;
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: 15px;
        border: 2px solid #e1e8ed;
        border-radius: 10px;
        font-size: 16px;
        transition: border-color 0.3s;
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: #667eea;
      }

      .api-key-input {
        font-family: monospace;
        letter-spacing: 1px;
      }

      .btn {
        width: 100%;
        padding: 15px;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s;
        margin-bottom: 15px;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .btn-secondary {
        background: #f8f9fa;
        color: #6c757d;
        border: 2px solid #e1e8ed;
      }

      .btn-secondary:hover {
        background: #e9ecef;
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .info-box {
        background: #f8f9fa;
        border: 1px solid #e1e8ed;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 25px;
      }

      .info-box h3 {
        color: #2c3e50;
        margin-bottom: 10px;
        font-size: 1.1rem;
      }

      .info-box p {
        color: #6c757d;
        line-height: 1.6;
        margin-bottom: 10px;
      }

      .info-box ul {
        margin-left: 20px;
        color: #6c757d;
      }

      .info-box li {
        margin-bottom: 5px;
      }

      .status-message {
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        display: none;
      }

      .status-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .demo-mode {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        text-align: center;
      }

      .link {
        color: #667eea;
        text-decoration: none;
      }

      .link:hover {
        text-decoration: underline;
      }

      .btn-refresh {
        margin-top: 10px;
        padding: 8px 16px;
        background: #f8f9fa;
        border: 1px solid #e1e8ed;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s;
      }

      .btn-refresh:hover {
        background: #e9ecef;
      }

      @media (max-width: 768px) {
        .login-container {
          margin: 10px;
        }

        .header {
          padding: 20px;
        }

        .form-section {
          padding: 20px;
        }

        .header h1 {
          font-size: 1.5rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="login-container">
      <div class="header">
        <h1>ğŸ”‘ APIå¯†é’¥è®¾ç½®</h1>
        <p>é…ç½®æ‚¨çš„AIæœåŠ¡å¯†é’¥ä»¥è·å¾—æ›´å¥½çš„æœç´¢ä½“éªŒ</p>
      </div>

      <div class="form-section">
        <div class="demo-mode">
          <strong>ğŸ’¡ æç¤ºï¼š</strong> æ‚¨ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨æ¼”ç¤ºæ¨¡å¼ï¼Œæ— éœ€APIå¯†é’¥
        </div>

        <div class="info-box">
          <h3>ğŸ¤– æ”¯æŒçš„AIæœåŠ¡</h3>
          <p>æˆ‘ä»¬æ”¯æŒä»¥ä¸‹AIæœåŠ¡æä¾›å•†ï¼š</p>
          <ul>
            <li><strong>Aihubmix</strong> - æ¨èï¼Œå¤§é™†ç”¨æˆ·ç›´è¿ä½¿ç”¨</li>
            <li><strong>OpenAI</strong> - éœ€è¦ç½‘ç»œä»£ç†</li>
          </ul>
          <p>
            <a
              href="https://docs.aihubmix.com/cn/api/Aihubmix-Integration"
              target="_blank"
              class="link"
              >ğŸ“– æŸ¥çœ‹Aihubmix APIæ–‡æ¡£</a
            >
          </p>
        </div>

        <div id="statusMessage" class="status-message"></div>

        <form id="apiKeyForm">
          <div class="form-group">
            <label for="provider">AIæœåŠ¡æä¾›å•†</label>
            <select id="provider" name="provider">
              <option value="aihubmix">Aihubmix (æ¨è)</option>
              <option value="openai">OpenAI</option>
            </select>
          </div>

          <div class="form-group">
            <label for="model">AIæ¨¡å‹</label>
            <select id="model" name="model">
              <option value="">è¯·å…ˆé€‰æ‹©æä¾›å•†å¹¶è¾“å…¥APIå¯†é’¥</option>
            </select>
            <button
              type="button"
              id="refreshModelsBtn"
              class="btn-refresh"
              style="display: none"
            >
              ğŸ”„ åˆ·æ–°æ¨¡å‹åˆ—è¡¨
            </button>
          </div>

          <div class="form-group">
            <label for="apiKey">APIå¯†é’¥</label>
            <input
              type="password"
              id="apiKey"
              name="apiKey"
              class="api-key-input"
              placeholder="è¯·è¾“å…¥æ‚¨çš„APIå¯†é’¥"
              required
            />
          </div>

          <button type="submit" class="btn btn-primary" id="validateBtn">
            éªŒè¯å¹¶ä¿å­˜
          </button>
        </form>

        <button class="btn btn-secondary" id="demoBtn">ä½¿ç”¨æ¼”ç¤ºæ¨¡å¼</button>
      </div>
    </div>

    <script>
             // æ ¹æ®ç¯å¢ƒè‡ªåŠ¨é€‰æ‹©APIåœ°å€
       const API_BASE_URL = window.location.hostname === 'localhost' 
         ? "http://localhost:8000" 
         : "https://mtg-ai-backend.onrender.com";

      // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
      function showStatus(message, type = "success") {
        const statusDiv = document.getElementById("statusMessage");
        statusDiv.textContent = message;
        statusDiv.className = `status-message status-${type}`;
        statusDiv.style.display = "block";

        // 3ç§’åè‡ªåŠ¨éšè—
        setTimeout(() => {
          statusDiv.style.display = "none";
        }, 3000);
      }

      // è·å–æ¨¡å‹åˆ—è¡¨
      async function getModels(apiKey, provider) {
        try {
          const response = await fetch(`${API_BASE_URL}/api/models`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              api_key: apiKey,
              provider: provider,
            }),
          });

          const result = await response.json();
          return result;
        } catch (error) {
          console.error("è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥:", error);
          return {
            success: false,
            models: [],
            message: "ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œ",
          };
        }
      }

      // éªŒè¯APIå¯†é’¥
      async function validateApiKey(apiKey, provider, model) {
        try {
          const response = await fetch(`${API_BASE_URL}/api/validate-key`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              api_key: apiKey,
              provider: provider,
              model: model,
            }),
          });

          const result = await response.json();
          return result;
        } catch (error) {
          console.error("éªŒè¯å¤±è´¥:", error);
          return {
            valid: false,
            message: "ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œ",
          };
        }
      }

      // ä¿å­˜APIå¯†é’¥åˆ°æœ¬åœ°å­˜å‚¨
      function saveApiKey(apiKey, provider, model) {
        localStorage.setItem("mtg_ai_api_key", apiKey);
        localStorage.setItem("mtg_ai_provider", provider);
        localStorage.setItem("mtg_ai_model", model);
        localStorage.setItem("mtg_ai_configured", "true");
      }

      // è¡¨å•æäº¤å¤„ç†
      document
        .getElementById("apiKeyForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const apiKey = document.getElementById("apiKey").value.trim();
          const provider = document.getElementById("provider").value;
          const model = document.getElementById("model").value;
          const validateBtn = document.getElementById("validateBtn");

          if (!apiKey) {
            showStatus("è¯·è¾“å…¥APIå¯†é’¥", "error");
            return;
          }

          // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
          validateBtn.disabled = true;
          validateBtn.textContent = "éªŒè¯ä¸­...";

          try {
            const result = await validateApiKey(apiKey, provider, model);

            if (result.valid) {
              showStatus("âœ… APIå¯†é’¥éªŒè¯æˆåŠŸï¼", "success");
              saveApiKey(apiKey, provider, model);

              // å»¶è¿Ÿè·³è½¬åˆ°ä¸»é¡µé¢
              setTimeout(() => {
                window.location.href = "index.html";
              }, 1500);
            } else {
              showStatus(`âŒ ${result.message}`, "error");
            }
          } catch (error) {
            showStatus("éªŒè¯è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯", "error");
          } finally {
            validateBtn.disabled = false;
            validateBtn.textContent = "éªŒè¯å¹¶ä¿å­˜";
          }
        });

      // åŠ¨æ€è·å–æ¨¡å‹åˆ—è¡¨
      async function loadModels(apiKey, provider) {
        const modelSelect = document.getElementById("model");
        const refreshBtn = document.getElementById("refreshModelsBtn");

        if (!apiKey || !provider) {
          modelSelect.innerHTML =
            '<option value="">è¯·å…ˆé€‰æ‹©æä¾›å•†å¹¶è¾“å…¥APIå¯†é’¥</option>';
          refreshBtn.style.display = "none";
          return;
        }

        modelSelect.innerHTML = '<option value="">æ­£åœ¨è·å–æ¨¡å‹åˆ—è¡¨...</option>';
        refreshBtn.style.display = "none";

        const result = await getModels(apiKey, provider);

        if (result.success || result.models.length > 0) {
          modelSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æ¨¡å‹</option>';
          result.models.forEach((model) => {
            const option = document.createElement("option");
            option.value = model.id;
            option.textContent = model.name;
            modelSelect.appendChild(option);
          });
          refreshBtn.style.display = "inline-block";
        } else {
          modelSelect.innerHTML = '<option value="">è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥</option>';
        }
      }

      // æä¾›å•†æˆ–APIå¯†é’¥å˜åŒ–æ—¶è·å–æ¨¡å‹åˆ—è¡¨
      document.getElementById("provider").addEventListener("change", () => {
        const apiKey = document.getElementById("apiKey").value.trim();
        const provider = document.getElementById("provider").value;
        if (apiKey) {
          loadModels(apiKey, provider);
        }
      });

      document.getElementById("apiKey").addEventListener("input", () => {
        const apiKey = document.getElementById("apiKey").value.trim();
        const provider = document.getElementById("provider").value;
        if (apiKey && provider) {
          loadModels(apiKey, provider);
        }
      });

      // åˆ·æ–°æ¨¡å‹åˆ—è¡¨æŒ‰é’®
      document
        .getElementById("refreshModelsBtn")
        .addEventListener("click", async () => {
          const apiKey = document.getElementById("apiKey").value.trim();
          const provider = document.getElementById("provider").value;
          if (apiKey && provider) {
            await loadModels(apiKey, provider);
            showStatus("æ¨¡å‹åˆ—è¡¨å·²åˆ·æ–°", "success");
          }
        });

      // æ¼”ç¤ºæ¨¡å¼æŒ‰é’®
      document.getElementById("demoBtn").addEventListener("click", () => {
        localStorage.setItem("mtg_ai_configured", "true");
        localStorage.removeItem("mtg_ai_api_key");
        localStorage.removeItem("mtg_ai_provider");
        localStorage.removeItem("mtg_ai_model");
        window.location.href = "index.html";
      });

      // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦å·²ç»é…ç½®
      document.addEventListener("DOMContentLoaded", () => {
        const isConfigured = localStorage.getItem("mtg_ai_configured");
        if (isConfigured === "true") {
          // å¦‚æœå·²ç»é…ç½®è¿‡ï¼Œç›´æ¥è·³è½¬åˆ°ä¸»é¡µé¢
          window.location.href = "index.html";
        }
      });
    </script>
  </body>
</html>
