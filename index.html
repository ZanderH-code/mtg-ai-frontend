<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MTG AI æœç´¢å·¥å…·</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
      }

      .header p {
        font-size: 1.1rem;
        opacity: 0.9;
      }

      .api-status {
        margin-top: 15px;
      }

      .api-badge {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .api-badge.aihubmix {
        background: #28a745;
        color: white;
      }

      .api-badge.openai {
        background: #007bff;
        color: white;
      }

      .api-badge.demo {
        background: #ffc107;
        color: #212529;
      }

      .api-badge.fallback {
        background: #6c757d;
        color: white;
      }

      .search-section {
        padding: 40px;
      }

      .search-box {
        display: flex;
        gap: 15px;
        margin-bottom: 30px;
      }

      .search-input {
        flex: 1;
        padding: 15px 20px;
        border: 2px solid #e1e8ed;
        border-radius: 10px;
        font-size: 16px;
        transition: border-color 0.3s;
      }

      .search-input:focus {
        outline: none;
        border-color: #667eea;
      }

      .search-btn {
        padding: 15px 30px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        cursor: pointer;
        transition: transform 0.2s;
      }

      .search-btn:hover {
        transform: translateY(-2px);
      }

      .search-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .language-toggle {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }

      .lang-btn {
        padding: 8px 16px;
        border: 2px solid #e1e8ed;
        background: white;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .lang-btn.active {
        background: #667eea;
        color: white;
        border-color: #667eea;
      }

      .results-section {
        padding: 0 40px 40px;
      }

      .query-info {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        font-family: monospace;
        font-size: 14px;
      }

      .cards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 25px;
        padding: 20px 0;
      }

      .card {
        border: 1px solid #e1e8ed;
        border-radius: 15px;
        overflow: hidden;
        transition: transform 0.3s, box-shadow 0.3s;
        background: white;
        display: flex;
        flex-direction: column;
      }

      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      }

      .card-image {
        width: 100%;
        background: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6c757d;
        position: relative;
        overflow: hidden;
      }

      .card-image img {
        width: 100%;
        height: auto;
        display: block;
        transition: transform 0.3s;
      }

      .card:hover .card-image img {
        transform: scale(1.05);
      }

      .card-content {
        padding: 20px;
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      .card-name {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 10px;
        color: #2c3e50;
        line-height: 1.3;
      }

      .card-type {
        color: #6c757d;
        font-size: 14px;
        margin-bottom: 10px;
        font-style: italic;
      }

      .card-text {
        font-size: 14px;
        line-height: 1.6;
        color: #495057;
        flex: 1;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 4;
        -webkit-box-orient: vertical;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #6c757d;
      }

      .error {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
      }

      .example-queries {
        margin-top: 20px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
      }

      .example-queries h3 {
        margin-bottom: 15px;
        color: #2c3e50;
      }

      .example-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      .example-item {
        background: white;
        padding: 8px 16px;
        border-radius: 20px;
        border: 1px solid #e1e8ed;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 14px;
      }

      .example-item:hover {
        background: #667eea;
        color: white;
        border-color: #667eea;
      }

      .settings-bar {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }

      .settings-btn,
      .api-info-btn {
        padding: 8px 16px;
        border: 2px solid #e1e8ed;
        background: white;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 14px;
      }

      .settings-btn:hover,
      .api-info-btn:hover {
        background: #667eea;
        color: white;
        border-color: #667eea;
      }

      @media (max-width: 768px) {
        .search-box {
          flex-direction: column;
        }

        .cards-grid {
          grid-template-columns: 1fr;
          gap: 20px;
        }

        .header h1 {
          font-size: 2rem;
        }

        .card-content {
          padding: 15px;
        }

        .card-name {
          font-size: 16px;
        }

        .card-text {
          -webkit-line-clamp: 3;
        }
      }

      @media (max-width: 480px) {
        .container {
          margin: 10px;
          border-radius: 15px;
        }

        .search-section {
          padding: 20px;
        }

        .results-section {
          padding: 0 20px 20px;
        }

        .cards-grid {
          gap: 15px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ´ MTG AI æœç´¢å·¥å…·</h1>
        <p>ç”¨è‡ªç„¶è¯­è¨€æœç´¢ä¸‡æ™ºç‰Œå¡ç‰Œ</p>
        <div class="api-status" id="apiStatus" style="display: none">
          <span class="api-badge" id="apiBadge"></span>
        </div>
      </div>

      <div class="search-section">
        <div class="language-toggle">
          <button class="lang-btn active" data-lang="zh">ä¸­æ–‡</button>
          <button class="lang-btn" data-lang="en">English</button>
        </div>

        <div class="search-box">
          <input
            type="text"
            class="search-input"
            placeholder="ä¾‹å¦‚ï¼šåœ°è½å¡ç»„çš„å¼ºåŠ›ç»ˆç«¯"
            id="searchInput"
          />
          <button class="search-btn" id="searchBtn">æœç´¢</button>
        </div>

        <div class="settings-bar">
          <button class="settings-btn" id="settingsBtn">âš™ï¸ è®¾ç½®</button>
          <button class="api-info-btn" id="apiInfoBtn">â„¹ï¸ APIä¿¡æ¯</button>
        </div>

        <div class="example-queries">
          <h3>ğŸ’¡ æœç´¢ç¤ºä¾‹</h3>
          <div class="example-list">
            <div class="example-item" data-query="åœ°è½å¡ç»„çš„å¼ºåŠ›ç»ˆç«¯">
              åœ°è½å¡ç»„çš„å¼ºåŠ›ç»ˆç«¯
            </div>
            <div class="example-item" data-query="ç»¿è‰²çš„ç”Ÿç‰©å¡">
              ç»¿è‰²çš„ç”Ÿç‰©å¡
            </div>
            <div class="example-item" data-query="è´¹ç”¨åœ¨3ç‚¹ä»¥ä¸‹çš„ç¬é—´">
              è´¹ç”¨åœ¨3ç‚¹ä»¥ä¸‹çš„ç¬é—´
            </div>
            <div class="example-item" data-query="åŠ›é‡å¤§äº4çš„çº¢è‰²ç”Ÿç‰©">
              åŠ›é‡å¤§äº4çš„çº¢è‰²ç”Ÿç‰©
            </div>
            <div class="example-item" data-query="ç¥å™¨æˆ–ç»“ç•Œå¡">
              ç¥å™¨æˆ–ç»“ç•Œå¡
            </div>
            <div class="example-item" data-query="ç¨€æœ‰åº¦ç¥è¯çš„å¡ç‰Œ">
              ç¨€æœ‰åº¦ç¥è¯çš„å¡ç‰Œ
            </div>
            <div class="example-item" data-query="landfall finisher">
              landfall finisher
            </div>
            <div class="example-item" data-query="red creatures with power 4+">
              red creatures with power 4+
            </div>
          </div>
        </div>
      </div>

      <div class="results-section" id="resultsSection" style="display: none">
        <div class="query-info" id="queryInfo"></div>
        <div class="cards-grid" id="cardsGrid"></div>
      </div>
    </div>

    <script>
             // æ ¹æ®ç¯å¢ƒè‡ªåŠ¨é€‰æ‹©APIåœ°å€
       const API_BASE_URL = window.location.hostname === 'localhost' 
         ? "http://localhost:8000" 
         : "https://mtg-ai-backend.onrender.com";

      let currentLanguage = "zh";
      let currentApiKey = null;
      let currentProvider = null;
      let currentModel = null;

      // è¯­è¨€åˆ‡æ¢
      document.querySelectorAll(".lang-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          document
            .querySelectorAll(".lang-btn")
            .forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          currentLanguage = btn.dataset.lang;

          // æ›´æ–°è¾“å…¥æ¡†å ä½ç¬¦
          const input = document.getElementById("searchInput");
          if (currentLanguage === "zh") {
            input.placeholder = "ä¾‹å¦‚ï¼šåœ°è½å¡ç»„çš„å¼ºåŠ›ç»ˆç«¯";
          } else {
            input.placeholder = "ä¾‹å¦‚ï¼šlandfall finisher";
          }
        });
      });

      // ç¤ºä¾‹æŸ¥è¯¢ç‚¹å‡»
      document.querySelectorAll(".example-item").forEach((item) => {
        item.addEventListener("click", () => {
          document.getElementById("searchInput").value = item.dataset.query;
          performSearch();
        });
      });

      // æœç´¢æŒ‰é’®ç‚¹å‡»
      document
        .getElementById("searchBtn")
        .addEventListener("click", performSearch);

      // å›è½¦æœç´¢
      document
        .getElementById("searchInput")
        .addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            performSearch();
          }
        });

      async function performSearch() {
        const query = document.getElementById("searchInput").value.trim();
        if (!query) return;

        const searchBtn = document.getElementById("searchBtn");
        const resultsSection = document.getElementById("resultsSection");
        const cardsGrid = document.getElementById("cardsGrid");

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        searchBtn.disabled = true;
        searchBtn.textContent = "æœç´¢ä¸­...";
        resultsSection.style.display = "block";
        cardsGrid.innerHTML = '<div class="loading">ğŸ” æ­£åœ¨æœç´¢å¡ç‰Œ...</div>';

        try {
          const response = await fetch(`${API_BASE_URL}/api/search`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              query: query,
              language: currentLanguage,
              api_key: currentApiKey,
              model: currentModel,
            }),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          displayResults(data);
        } catch (error) {
          console.error("Search error:", error);
          cardsGrid.innerHTML = `
                    <div class="error">
                        âŒ æœç´¢å¤±è´¥: ${error.message}
                        <br><br>
                        è¯·æ£€æŸ¥ï¼š
                        <ul style="margin-left: 20px; margin-top: 10px;">
                            <li>åç«¯æœåŠ¡æ˜¯å¦æ­£åœ¨è¿è¡Œ</li>
                            <li>APIåœ°å€æ˜¯å¦æ­£ç¡®</li>
                            <li>ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸</li>
                        </ul>
                    </div>
                `;
        } finally {
          searchBtn.disabled = false;
          searchBtn.textContent = "æœç´¢";
        }
      }

      function displayResults(data) {
        const queryInfo = document.getElementById("queryInfo");
        const cardsGrid = document.getElementById("cardsGrid");

        // æ˜¾ç¤ºæŸ¥è¯¢ä¿¡æ¯
        queryInfo.innerHTML = `
                 <strong>Scryfall æŸ¥è¯¢è¯­æ³•:</strong> ${data.scryfall_query}<br>
                 <strong>æ‰¾åˆ°å¡ç‰Œæ•°é‡:</strong> ${data.total_cards}
                 ${
                   data.api_provider
                     ? `<br><strong>AIæä¾›å•†:</strong> ${data.api_provider.toUpperCase()}`
                     : ""
                 }
             `;

        // æ˜¾ç¤ºå¡ç‰Œ
        if (data.cards.length === 0) {
          cardsGrid.innerHTML =
            '<div class="loading">ğŸ˜• æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„å¡ç‰Œ</div>';
          return;
        }

        cardsGrid.innerHTML = data.cards
          .map(
            (card) => `
                <div class="card">
                    <div class="card-image">
                        ${
                          card.image_uris
                            ? `<img src="${card.image_uris.small}" alt="${card.name}" loading="lazy">`
                            : "ğŸƒ æš‚æ— å›¾ç‰‡"
                        }
                    </div>
                    <div class="card-content">
                        <div class="card-name">${card.name}</div>
                        <div class="card-type">${card.type_line}</div>
                        <div class="card-text">${
                          card.oracle_text || "æ— è§„åˆ™æ–‡æœ¬"
                        }</div>
                    </div>
                </div>
            `
          )
          .join("");
      }

      // è®¾ç½®æŒ‰é’®ç‚¹å‡»
      document.getElementById("settingsBtn").addEventListener("click", () => {
        // æ¸…é™¤é…ç½®å¹¶è·³è½¬åˆ°ç™»å½•é¡µé¢
        localStorage.removeItem("mtg_ai_configured");
        localStorage.removeItem("mtg_ai_api_key");
        localStorage.removeItem("mtg_ai_provider");
        window.location.href = "login.html";
      });

      // APIä¿¡æ¯æŒ‰é’®ç‚¹å‡»
      document.getElementById("apiInfoBtn").addEventListener("click", () => {
        const apiKey = localStorage.getItem("mtg_ai_api_key");
        const provider = localStorage.getItem("mtg_ai_provider");
        const model = localStorage.getItem("mtg_ai_model");

        if (apiKey && provider) {
          alert(
            `å½“å‰ä½¿ç”¨: ${provider.toUpperCase()}\næ¨¡å‹: ${
              model || "é»˜è®¤"
            }\nAPIå¯†é’¥: ${apiKey.substring(0, 8)}...`
          );
        } else {
          alert("å½“å‰ä½¿ç”¨æ¼”ç¤ºæ¨¡å¼ï¼Œæ— éœ€APIå¯†é’¥");
        }
      });

      // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
      document.addEventListener("DOMContentLoaded", () => {
        console.log("MTG AI Search Tool loaded!");

        // æ£€æŸ¥APIé…ç½®
        const isConfigured = localStorage.getItem("mtg_ai_configured");
        if (isConfigured !== "true") {
          // å¦‚æœæ²¡æœ‰é…ç½®ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢
          window.location.href = "login.html";
          return;
        }

        // åŠ è½½APIé…ç½®
        currentApiKey = localStorage.getItem("mtg_ai_api_key");
        currentProvider = localStorage.getItem("mtg_ai_provider");
        currentModel = localStorage.getItem("mtg_ai_model");

        // æ˜¾ç¤ºAPIçŠ¶æ€
        updateApiStatus();
      });

      // æ›´æ–°APIçŠ¶æ€æ˜¾ç¤º
      function updateApiStatus() {
        const apiStatus = document.getElementById("apiStatus");
        const apiBadge = document.getElementById("apiBadge");

        if (currentApiKey && currentProvider) {
          apiStatus.style.display = "block";
          const modelText = currentModel ? ` (${currentModel})` : "";
          apiBadge.textContent = currentProvider.toUpperCase() + modelText;
          apiBadge.className = `api-badge ${currentProvider}`;
        } else {
          apiStatus.style.display = "block";
          apiBadge.textContent = "DEMO";
          apiBadge.className = "api-badge demo";
        }
      }
    </script>
  </body>
</html>
